<!DOCTYPE html>
<html lang="en-IN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMI Master Pro | Advanced Indian Loan Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
        }

        .year-header {
            cursor: pointer;
            transition: all 0.2s;
        }

        .year-header:hover {
            background-color: #f1f5f9;
        }

        .month-row {
            display: none;
        }

        .bg-prepay {
            background-color: #f0fdf4 !important;
            color: #166534;
            font-weight: 600;
        }

        input,
        select {
            outline: none !important;
            transition: border 0.2s;
        }

        input:focus {
            border-color: #2563eb !important;
        }

        .custom-scroll::-webkit-scrollbar {
            height: 6px;
            width: 6px;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        .card-shadow {
            box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>

<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-6">
            <div>
                <h1 class="text-3xl font-black text-slate-900 tracking-tight">EMI <span
                        class="text-blue-600">MASTER</span> PRO</h1>
                <p class="text-slate-500 font-medium">Real-time Loan Analysis with Prepayment Savings</p>
            </div>
            <div class="flex gap-2">
                <button onclick="exportData()"
                    class="px-4 py-2 bg-slate-800 text-white rounded-xl text-xs font-bold hover:bg-slate-700 transition">DOWNLOAD
                    BACKUP</button>
                <button onclick="clearSavedData()"
                    class="px-4 py-2 bg-red-50 text-red-600 border border-red-100 rounded-xl text-xs font-bold hover:bg-red-100 transition">RESET
                    ALL</button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">

            <div class="lg:col-span-4 space-y-6">

                <div class="bg-white p-6 rounded-3xl card-shadow border border-slate-200">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4 flex items-center gap-2">
                        <span class="w-2 h-2 bg-blue-600 rounded-full"></span> Loan Setup
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="text-[11px] font-bold text-slate-500 uppercase">Sanctioned Amount (₹)</label>
                            <input type="text" id="balance"
                                class="inr-input w-full mt-1 p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-slate-800"
                                value="30,00,000">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-[11px] font-bold text-slate-500 uppercase">Rate (% P.A.)</label>
                                <input type="number" step="0.01" id="rate"
                                    class="w-full mt-1 p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-slate-800"
                                    value="8.65">
                            </div>
                            <div>
                                <label class="text-[11px] font-bold text-slate-500 uppercase">Tenure (Months)</label>
                                <input type="number" id="tenure"
                                    class="w-full mt-1 p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-slate-800"
                                    value="120">
                            </div>
                        </div>
                        <div>
                            <label class="text-[11px] font-bold text-slate-500 uppercase">First EMI Date</label>
                            <input type="date" id="startDate"
                                class="w-full mt-1 p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-slate-800"
                                value="2025-11-03">
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-3xl card-shadow border border-slate-200">
                    <h3 class="text-sm font-bold text-emerald-600 uppercase tracking-wider mb-4">Recurring Prepayments
                    </h3>
                    <div class="space-y-4">
                        <div class="p-3 bg-emerald-50 rounded-2xl border border-emerald-100">
                            <label class="text-[10px] font-bold text-emerald-700">MONTHLY EXTRA</label>
                            <div class="flex gap-2 mt-1">
                                <input type="text" id="mExtra"
                                    class="inr-input p-2 rounded-lg border-none w-2/3 text-sm font-bold" value="0">
                                <input type="month" id="mStart" class="p-2 rounded-lg border-none w-full text-xs"
                                    value="2026-02">
                            </div>
                        </div>
                        <div class="p-3 bg-blue-50 rounded-2xl border border-blue-100">
                            <label class="text-[10px] font-bold text-blue-700">YEARLY EXTRA</label>
                            <div class="flex gap-2 mt-1">
                                <input type="text" id="yExtra"
                                    class="inr-input p-2 rounded-lg border-none w-2/3 text-sm font-bold" value="0">
                                <input type="month" id="yStart" class="p-2 rounded-lg border-none w-full text-xs"
                                    value="2026-02">
                            </div>
                        </div>
                        <div class="p-3 bg-purple-50 rounded-2xl border border-purple-100">
                            <label class="text-[10px] font-bold text-purple-700">QUARTERLY EXTRA</label>
                            <div class="flex gap-2 mt-1">
                                <input type="text" id="qExtra"
                                    class="inr-input p-2 rounded-lg border-none w-2/3 text-sm font-bold" value="0">
                                <input type="month" id="qStart" class="p-2 rounded-lg border-none w-full text-xs"
                                    value="2026-04">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-3xl card-shadow border border-slate-200">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-sm font-bold text-orange-600 uppercase tracking-wider">Lump Sum Payments</h3>
                        <button onclick="addOtpRow()"
                            class="bg-orange-600 text-white w-7 h-7 rounded-full font-bold shadow-md hover:bg-orange-700">+</button>
                    </div>
                    <div id="otpContainer" class="space-y-3">
                    </div>
                </div>
            </div>

            <div class="lg:col-span-8 space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="bg-white p-5 rounded-3xl card-shadow border-b-4 border-blue-500">
                        <p class="text-[10px] font-bold text-slate-400 uppercase">Interest Paid</p>
                        <p id="dashInterest" class="text-xl font-black text-slate-800">₹ 0</p>
                        <span id="dashInterestSaved" class="text-[10px] font-bold text-emerald-600 italic">Saved: ₹
                            0</span>
                    </div>
                    <div class="bg-white p-5 rounded-3xl card-shadow border-b-4 border-emerald-500">
                        <p class="text-[10px] font-bold text-slate-400 uppercase">Total Outflow</p>
                        <p id="dashTotalPaid" class="text-xl font-black text-slate-800">₹ 0</p>
                        <span id="dashTotalSaved" class="text-[10px] font-bold text-emerald-600 italic">Total Saved: ₹
                            0</span>
                    </div>
                    <div class="bg-white p-5 rounded-3xl card-shadow border-b-4 border-orange-500">
                        <p class="text-[10px] font-bold text-slate-400 uppercase">Tenure Saved</p>
                        <p id="dashTenureSaved" class="text-xl font-black text-slate-800">0 Months</p>
                        <span id="dashMonthsRemaining" class="text-[10px] font-bold text-orange-600 italic">New Tenure:
                            0 mo</span>
                    </div>
                    <div class="bg-white p-5 rounded-3xl card-shadow border-b-4 border-slate-800">
                        <p class="text-[10px] font-bold text-slate-400 uppercase">Est. End Date</p>
                        <p id="dashEndDate" class="text-xl font-black text-slate-800">-</p>
                        <span id="dashOriginalEnd" class="text-[10px] font-bold text-slate-400 italic">Orig: -</span>
                    </div>
                </div>

                <div class="bg-white rounded-3xl card-shadow border border-slate-200 overflow-hidden">
                    <div class="p-4 bg-slate-50 border-b border-slate-200 flex justify-between items-center">
                        <h3 class="font-bold text-slate-700">Amortization Schedule</h3>
                        <span class="text-[10px] text-slate-400 font-bold uppercase tracking-tight">Click year to expand
                            months</span>
                    </div>
                    <div class="overflow-x-auto custom-scroll max-h-[600px]">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-white sticky top-0 shadow-sm z-10">
                                <tr class="text-[10px] text-slate-400 uppercase font-bold">
                                    <th class="p-4">#</th>
                                    <th class="p-4">Period</th>
                                    <th class="p-4 text-right">Principal</th>
                                    <th class="p-4 text-right">Interest</th>
                                    <th class="p-4 text-right">Total</th>
                                    <th class="p-4 text-right">Balance</th>
                                </tr>
                            </thead>
                            <tbody id="scheduleBody" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- HELPERS ---
        function formatINR(n) { return new Intl.NumberFormat('en-IN', { maximumFractionDigits: 0 }).format(Math.round(n)); }
        function parseINR(val) { return parseFloat(val.toString().replace(/,/g, '')) || 0; }

        // --- STORAGE & SAVE LOGIC ---
        function saveToLocal() {
            const lumpSums = [];
            $('.otp-row').each(function () {
                lumpSums.push({
                    amt: $(this).find('.otp-amt').val(),
                    date: $(this).find('.otp-date').val()
                });
            });

            const data = {
                balance: $('#balance').val(),
                rate: $('#rate').val(),
                tenure: $('#tenure').val(),
                startDate: $('#startDate').val(),
                mExtra: $('#mExtra').val(),
                mStart: $('#mStart').val(),
                qExtra: $('#qExtra').val(),
                qStart: $('#qStart').val(),
                yExtra: $('#yExtra').val(),
                yStart: $('#yStart').val(),
                lumpSums: lumpSums
            };
            localStorage.setItem('emi_pro_data', JSON.stringify(data));
        }

        function loadFromLocal() {
            const saved = localStorage.getItem('emi_pro_data');
            if (!saved) {
                addOtpRow(); // Add one default row if no data
                return;
            }
            const data = JSON.parse(saved);
            $('#balance').val(data.balance);
            $('#rate').val(data.rate);
            $('#tenure').val(data.tenure);
            $('#startDate').val(data.startDate);
            $('#mExtra').val(data.mExtra);
            $('#mStart').val(data.mStart);
            $('#qExtra').val(data.qExtra);
            $('#qStart').val(data.qStart);
            $('#yExtra').val(data.yExtra);
            $('#yStart').val(data.yStart);

            $('#otpContainer').empty();
            if (data.lumpSums && data.lumpSums.length > 0) {
                data.lumpSums.forEach(item => addOtpRow(item.amt, item.date));
            } else {
                addOtpRow();
            }
        }

        function clearSavedData() {
            if (confirm("Are you sure you want to clear all inputs?")) {
                localStorage.removeItem('emi_pro_data');
                location.reload();
            }
        }

        function exportData() {
            const data = localStorage.getItem('emi_pro_data');
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `EMI_Backup_${new Date().toISOString().slice(0, 10)}.json`;
            a.click();
        }

        // Modified Add Row to accept parameters
        function addOtpRow(amt = "0", date = "") {
            $('#otpContainer').append(`
                <div class="otp-row flex gap-2 mt-2">
                    <input type="text" class="otp-amt inr-input w-2/3 p-2 bg-orange-50 rounded-lg text-sm font-bold" value="${amt}">
                    <input type="date" class="otp-date w-full p-2 bg-orange-50 rounded-lg text-[10px]" value="${date}">
                    <button onclick="$(this).parent().remove(); calculate(); saveToLocal();" class="text-red-400 font-bold px-1 text-xl">&times;</button>
                </div>
            `);
        }

        // Live Formatting for Currency Inputs
        $(document).on('input', '.inr-input', function () {
            let cursorPosition = this.selectionStart;
            let originalLength = this.value.length;
            let val = $(this).val().replace(/[^0-9]/g, '');
            if (val) {
                $(this).val(formatINR(val));
                let newLength = this.value.length;
                this.setSelectionRange(cursorPosition + (newLength - originalLength), cursorPosition + (newLength - originalLength));
            }
        });

        // --- CALCULATION ENGINE (Original Logic Maintained) ---
        function calculate() {
            let origBal = parseINR($('#balance').val());
            if (origBal <= 0) return;

            let annualRate = parseFloat($('#rate').val()) / 100;
            let tenureMonths = parseInt($('#tenure').val());
            if (!annualRate || !tenureMonths) return;

            let monthlyRate = annualRate / 12;
            let emi = origBal * monthlyRate * Math.pow(1 + monthlyRate, tenureMonths) / (Math.pow(1 + monthlyRate, tenureMonths) - 1);

            let baseTotalInterest = (emi * tenureMonths) - origBal;
            let baseTotalPaid = emi * tenureMonths;
            let baseEndDate = new Date($('#startDate').val());
            baseEndDate.setMonth(baseEndDate.getMonth() + (tenureMonths - 1));

            let currDate = new Date($('#startDate').val());
            let cycleStart = new Date(currDate);
            cycleStart.setDate(cycleStart.getDate() - 30);

            let mAmt = parseINR($('#mExtra').val()), mS = new Date($('#mStart').val() + "-01");
            let qAmt = parseINR($('#qExtra').val()), qS = new Date($('#qStart').val() + "-01");
            let yAmt = parseINR($('#yExtra').val()), yS = new Date($('#yStart').val() + "-01");

            let otpList = [];
            $('.otp-row').each(function () {
                let a = parseINR($(this).find('.otp-amt').val());
                let d = $(this).find('.otp-date').val();
                if (a > 0 && d) otpList.push({ a, d: new Date(d) });
            });

            let yearlyData = {};
            let globalMonthCount = 0;
            let totalInterestPaid = 0;
            let balance = origBal;
            let lastPaymentDate = new Date(currDate);

            for (let i = 1; i <= 600 && balance > 0.01; i++) {
                let year = currDate.getFullYear();
                if (!yearlyData[year]) yearlyData[year] = { p: 0, int: 0, t: 0, b: 0, m: [] };

                let cycleEnd = new Date(currDate);
                let monthInt = 0;
                let lastD = new Date(cycleStart);
                let monthPrincipalPaid = 0;

                let midOtps = otpList.filter(o => o.d > cycleStart && o.d <= cycleEnd).sort((a, b) => a.d - b.d);
                midOtps.forEach(p => {
                    let dDiff = Math.floor((p.d - lastD) / 86400000);
                    monthInt += (balance * annualRate * dDiff) / 365;
                    let amtToPay = Math.min(balance, p.a);
                    balance -= amtToPay;
                    monthPrincipalPaid += amtToPay;
                    lastD = new Date(p.d);
                    yearlyData[year].m.push({ count: '-', label: p.d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short' }) + " (Lump Sum)", p: amtToPay, i: 0, b: balance, type: 'B' });
                });

                let remD = Math.floor((cycleEnd - lastD) / 86400000);
                monthInt += (balance * annualRate * remD) / 365;
                monthInt = Math.round(monthInt);

                let prinFromEmi = Math.min(balance, emi - monthInt);
                balance -= prinFromEmi;
                monthPrincipalPaid += prinFromEmi;
                totalInterestPaid += monthInt;
                globalMonthCount++;
                lastPaymentDate = new Date(currDate);

                yearlyData[year].m.push({ count: globalMonthCount, label: currDate.toLocaleDateString('en-GB', { month: 'short' }), p: prinFromEmi, i: monthInt, b: balance, type: 'E' });

                let extra = 0;
                if (mAmt > 0 && currDate >= mS) extra += mAmt;
                if (qAmt > 0 && currDate >= qS && ((currDate.getFullYear() - qS.getFullYear()) * 12 + currDate.getMonth() - qS.getMonth()) % 3 === 0) extra += qAmt;
                if (yAmt > 0 && currDate >= yS && currDate.getMonth() === yS.getMonth()) extra += yAmt;

                if (extra > 0 && balance > 0.01) {
                    let actualExtra = Math.min(balance, extra);
                    balance -= actualExtra;
                    monthPrincipalPaid += actualExtra;
                    yearlyData[year].m.push({ count: '-', label: 'Recurring Extra', p: actualExtra, i: 0, b: balance, type: 'B' });
                }

                yearlyData[year].p += monthPrincipalPaid;
                yearlyData[year].int += monthInt;
                yearlyData[year].t += (monthPrincipalPaid + monthInt);
                yearlyData[year].b = balance;

                cycleStart = new Date(currDate);
                currDate.setMonth(currDate.getMonth() + 1);
            }

            renderTable(yearlyData);

            let totalPaidWithPrepay = origBal + totalInterestPaid;
            $('#dashInterest').text('₹ ' + formatINR(totalInterestPaid));
            $('#dashInterestSaved').text('Saved: ₹ ' + formatINR(baseTotalInterest - totalInterestPaid));
            $('#dashTotalPaid').text('₹ ' + formatINR(totalPaidWithPrepay));
            $('#dashTotalSaved').text('Total Saved: ₹ ' + formatINR(baseTotalPaid - totalPaidWithPrepay));
            $('#dashTenureSaved').text((tenureMonths - globalMonthCount) + ' Months');
            $('#dashMonthsRemaining').text('New Tenure: ' + globalMonthCount + ' mo');
            $('#dashEndDate').text(lastPaymentDate.toLocaleDateString('en-GB', { month: 'short', year: 'numeric' }));
            $('#dashOriginalEnd').text('Orig: ' + baseEndDate.toLocaleDateString('en-GB', { month: 'short', year: 'numeric' }));
        }

        function renderTable(data) {
            let html = '';
            for (let yr in data) {
                let d = data[yr];
                html += `
                    <tr class="year-header font-bold text-slate-800 bg-slate-50 border-l-4 border-blue-500" onclick="$('.y-${yr}').toggle()">
                        <td class="p-4">Year ${yr}</td>
                        <td class="p-4 text-[10px] text-slate-400 uppercase">Yearly Total</td>
                        <td class="p-4 text-right">₹ ${formatINR(d.p)}</td>
                        <td class="p-4 text-right text-red-500">₹ ${formatINR(d.int)}</td>
                        <td class="p-4 text-right">₹ ${formatINR(d.t)}</td>
                        <td class="p-4 text-right text-blue-600 font-black">₹ ${formatINR(d.b)}</td>
                    </tr>
                `;
                d.m.forEach(m => {
                    html += `
                        <tr class="month-row y-${yr} ${m.type === 'B' ? 'bg-prepay' : 'text-slate-500'}">
                            <td class="p-3 pl-8 text-[10px]">${m.count}</td>
                            <td class="p-3 text-xs font-semibold uppercase tracking-tighter">${m.label}</td>
                            <td class="p-3 text-right">₹ ${formatINR(m.p)}</td>
                            <td class="p-3 text-right">₹ ${formatINR(m.i)}</td>
                            <td class="p-3 text-right font-bold text-slate-700">₹ ${formatINR(m.p + m.i)}</td>
                            <td class="p-3 text-right font-mono text-[11px]">₹ ${formatINR(m.b)}</td>
                        </tr>
                    `;
                });
            }
            $('#scheduleBody').html(html);
        }

        // --- INITIALIZATION ---
        $(document).ready(function () {
            loadFromLocal();
            calculate();

            $(document).on('input change keyup', 'input, select', function () {
                calculate();
                saveToLocal();
            });
        });
    </script>
</body>

</html>
